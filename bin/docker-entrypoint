#!/bin/sh
set -e

# Enable jemalloc if not already set (fallback)
if [ -z "${LD_PRELOAD}" ]; then
    if [ -f "/usr/lib/libjemalloc.so.2" ]; then
        LD_PRELOAD="/usr/lib/libjemalloc.so.2"
        export LD_PRELOAD
    fi
fi

# Run db:prepare if starting the server
# Checks if the command looks like starting a server (thrust, puma, or rails server)
case "$@" in
  *"./bin/thrust"*|*"puma"*|*"rails server"*)
    ./bin/rails db:prepare
    ;;
esac

exec "$@"
